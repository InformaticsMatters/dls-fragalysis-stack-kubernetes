---

- include_tasks: prep.yaml

# The user is expected to have attached a suitable OpenStack
# credential to the AWX Job so that the conventional
# authentication environment variables are defined.

# We expect OpenStack variables to be present in the file
# referred to by the environment variable 'OS_CLIENT_CONFIG_FILE'
# (injected by the corresponding AWX OpenStack credential): -
#
# clouds:
#   devstack:
#     auth:
#       auth_url: <auth-url>
#       domain_name: <domain>
#       password: <password>
#       project_domain_name: <project-domain-name>
#       project_name: <project-name>
#       username: <username>
#
# What is missing (AWX 11.2.0) is the 'project_domain_id'
# and unless we set `project_domain_id` we'll get the error: -
#
#     "The request you have made requires authentication. (HTTP 401)"
#
# So we *MUST* use 'project_domain_name' to carry in the vital ID.
# In the following we inject the missing 'project_domain_id' by copying the
# value in the 'project_domain_name' field.

- name: Get config filename
  set_fact:
    config_file: "{{ lookup('env', 'OS_CLIENT_CONFIG_FILE') }}"

- name: Assert config filename is defined
  assert:
    that: config_file|string|length > 0

- name: Load variables from OpenStack config file
  include_vars: "{{ config_file }}"

- name: Assert cloud project_domain_name field exists
  assert:
    that:
    - clouds.devstack.auth.project_domain_name is defined
    - clouds.devstack.auth.project_domain_name|length > 0

- name: Copy cloud authentication
  set_fact:
    cloud_auth: "{{ clouds.devstack.auth }}"

- name: Set cloud project_domain_id field
  set_fact:
    cloud_auth: "{{ cloud_auth | combine({item.key: item.value}) }}"
  with_items:
  - { key: 'project_domain_id', value: "{{ clouds.devstack.auth.project_domain_name }}" }
  when: clouds_auth.project_domain_id is not defined

# Iterate through the list of 'snapshot_volumes'
# and issue a snapshot request to OpenStack.

- name: Create volume snapshots
  os_volume_snapshot:
    force: yes
    volume: "{{ item }}"
    display_name: "{{ item }}@{{ ansible_date_time.iso8601 }}"
    display_description: "Automated Volume Snapshot"
    availability_zone: "{{ snapshot_az }}"
    timeout: 600
    auth: "{{ cloud_auth }}"
  loop: "{{ snapshot_volumes }}"
